<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PiTank</title>
		<meta name="description" content="JoyStick">
		<script src="joy.js"></script>
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>

    </style>

    
    <!-- Custom styles for this template -->
    <link href="style.css" rel="stylesheet">
  </head>
  <body class="text-center">
    <main class="form-signin">
      <form>
        <div id="connectionBlock">
          <h1 class="h3 mb-3 fw-normal">Connect to tank</h1>
          <div class="form-floating">
            <input type="email" class="form-control" id="customIP" placeholder="localhost">
            <label for="floatingInput">IP</label>
          </div>
          <div class="form-floating">
            <input type="text" class="form-control" id="customPort" placeholder="8081">
            <label for="floatingPassword">Port</label>
          </div>
          <label id="refreshRateText" for="customRange1" class="form-label">Refresh rate</label>
          <input onChange="rateUpdate()" type="range" class="form-range" id="refreshRate" min="20" max="1000" step="20">
          <div class="checkbox mb-3">
            <label>
              <input type="checkbox" value="remember-me"> PWM (Not in use)
            </label>
          </div>
          <button id="connectButton" onClick="customConnect()" class="w-100 btn btn-lg btn-primary" type="submit">Connect</button>
        </div>
        <br>
        <div id="joyDiv" class="mt-5 mb-3"></div>

        <pre id="direction"></pre>
        <p class="mt-5 mb-3 text-muted"> WIP: Niall</p>
      </form>
    </main>
    <script>
      var joyParam = { "title": "joystick",
                        "width": 300,
                        "height": 300 };
      var Joy = new JoyStick('joyDiv', joyParam);
      var connectionStatus = false;
      refreshRate = document.getElementById("refreshRate");
      refreshRateText = document.getElementById("refreshRateText");
      connectionBlock = document.getElementById("connectionBlock");
      const status = document.getElementById("status"),
			direction = document.getElementById("direction"),
			customInput = document.getElementById("customIP"),
			connectButton = document.getElementById("connectButton")
      rateUpdate();

      function connect(t) {

        var url = `ws://${customIP.value}:${customPort.value}`;
				console.log(`Trying to connect to ${url}`)
        try {
          ws = new WebSocket(`${url}`), ws.addEventListener("open", () => {
					connectionStatus = !0, console.log("We are connected"), updateDisplay()
				  }), ws.addEventListener("close", () => {
					connectionStatus = !1, console.log("We were disconnected"), updateDisplay()
				  })
        } catch {
          console.log("Couldn't connect to " + url)
        }
			};

      function rateUpdate(){
        refreshRateText.textContent = "Refresh rate (ms): " + refreshRate.value;
      }

			function customConnect() {
				connect(customInput.value)
			};

			function updateDisplay() {
				1 == connectionStatus ? connectBlock.style.visibility = 'hidden' : connectBlock.style.visibility = 'visbible'
			};

			setInterval(function() {
				payload = {
					X: Joy.GetX(),
					Y: Joy.GetY()
				};

				direction.innerHTML = JSON.stringify(payload), 
				1 == connectionStatus && ws.send(JSON.stringify(payload));
			}, parseInt(refreshRate.value)), 
			connect("localhost"), updateDisplay();
    </script>
  </body>
</html>
